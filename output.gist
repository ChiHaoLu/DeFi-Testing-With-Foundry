<h1 id="quick-look-defi-contract-testing-with-foundry">Quick Look DeFi
Contract Testing With Foundry</h1>
<h6 id="tags-topic">tags: <code>TOPIC</code></h6>
<p><strong>Final Updated: 2022/5/24</strong></p>
<blockquote>
<p>æœ€è¿‘é–‹å§‹å­¸ç¿’ Unit Testing å’Œ Foundryï¼Œé‚„æœ‰æ—©å°±æ‡‰è©²é–‹å§‹ç¢°ä½†ä¸€ç›´é€ƒé¿çš„
DeFiï¼Œä¹¾è„†æ‘»åœ¨ä¸€èµ·åšæˆ<del>æ’’å°¿ç‰›ä¸¸</del>ï¼Œå­¸ç¿’ç­†è¨˜ã€‚</p>
</blockquote>
<h2 id="table-of-contents">Table of Contents</h2>
<ul>
<li><a href="#Intro">Intro.</a></li>
<li><a href="#Cast-an-eye-over-the-â€œDeFi-Testingâ€">Cast an eye over the
â€œDeFi Testingâ€</a></li>
<li><a href="#â€œBrewingâ€-Time---Basic-Defi-Project">â€œBrewingâ€ Time -
Basic Defi Project</a></li>
<li><a href="#â€œTastingâ€-Time">â€œTastingâ€ Time</a></li>
<li><a href="#Tipsy">Tipsy</a></li>
<li><a href="#Foundry-De-Problem-List">Foundry De-Problem List</a></li>
</ul>
<h3 id="synchronization-link-tree">Synchronization Link Tree</h3>
<ul>
<li><a href="https://medium.com/@ChiHaoLu">Medium</a></li>
<li><a href="https://www.linkedin.com/in/ChiHaoLu/">LinkedIn</a></li>
<li><a href="https://github.com/ChiHaoLu">Github</a></li>
</ul>
<hr />
<h2 id="intro.">Intro.</h2>
<h3 id="subject">Subject</h3>
<p>å‰å…©å€‹æœˆä½¿ç”¨éçš„ Foundry
è®Šçš„è¶Šä¾†è¶Šæ½®äº†ï¼Œæ‰€ä»¥æƒ³ä¾†è·Ÿå¤§å®¶åˆ†äº«ä¸€ä¸‹é€™å€‹æ–°ç©çš„æ¸¬è©¦å·¥å…·ï¼</p>
<p>é€™æ¬¡çš„ä¸»è¦æµç¨‹ç‚ºï¼šå…ˆå¯«ä¸€å€‹ç°¡å–®çš„ DeFi Projectï¼Œæœ‰ Staking
çš„åŠŸèƒ½ï¼Œä¹‹å¾Œç”¨ Foundry å°å…¶é€²è¡Œæ¸¬è©¦ã€‚æœ¬ä¾†æƒ³è¦æŒ‘ç¾è¡Œçš„æœ‰å Project
ä¾†æ¸¬è©¦çš„ï¼Œä½†æ‰¾åˆ°çš„ DeFi Project
éƒ½æœ‰ä¸€é»é»å·¨æ‡‰è©²å€¼å¾—æ›´é•·çš„ç¯‡å¹…ç‰¹åˆ¥åˆ†äº«ï¼</p>
<div class="warning">
<p>Foundry
æ›´æ–°çš„é€Ÿåº¦é æ¯”æˆ‘æƒ³åƒä¸­å¿«ï¼Œä¸éæ˜¯ä¸€å€‹æœˆæ²’çœ‹è€Œå·²ï¼Œå¾ˆå¤šæ±è¥¿éƒ½å®Œå…¨é•·å¾—ä¸ä¸€æ¨£äº†ï¼Œæ‰€ä»¥å¤§å®¶å¦‚æœé‡åˆ°ä»»ä½•å•é¡Œå¯ä»¥å…ˆåƒè€ƒä¸€ä¸‹
<a href="#Foundry-Official-DocGithub">Reference ä¸­çš„å®˜æ–¹æ–‡ä»¶å€‘ã€‚</a></p>
</div>
<hr />
<h2 id="cast-an-eye-over-the-defi-testing-with-foundry">Cast an eye over
the â€œDeFi Testing with Foundryâ€</h2>
<h3 id="testing-type">Testing Type</h3>
<ul>
<li>Unit Tests
<ul>
<li>Unit Testing
é€šå¸¸æ˜¯æŒ‡å®Œæ•´ã€ç¨ç«‹åœ°æ¸¬è©¦æ¯ä¸€å€‹éƒ¨ä»¶ï¼Œåœ¨çµ¦å®šå„ç¨®è¼¸å…¥çš„æƒ…æ³ä¸‹å’Œé æœŸçš„è¼¸å‡ºè¦ç›¸ç¬¦ã€‚åœ¨æ¸¬è©¦çš„éç¨‹ä¸­é€šå¸¸ä¸æœƒè€ƒæ…®å…¶ä»–éƒ¨ä»¶çš„å½±éŸ¿ï¼Œåœ¨
Solidity æ’°å¯«çš„ Smat Contract ä¸­ï¼Œéƒ¨ä»¶é€šå¸¸æŒ‡çš„æ˜¯æ¯ä¸€å€‹ Functionã€‚</li>
<li>éœ€è¦æ³¨æ„çš„è¼¸å…¥æœ‰ï¼š
<ul>
<li>é‚Šéš›æ¸¬è³‡
<ul>
<li>ç©ºå­—ä¸²ã€bound(e.g.Â 0, min, max, 2^256, -2^128â€¦)</li>
</ul></li>
<li>æ¥µç«¯æ¸¬è³‡
<ul>
<li>è¶…é•·çš„è¼¸å…¥</li>
</ul></li>
<li>ç‰¹æ®Šæ¸¬è³‡
<ul>
<li>å«æœ‰ç‰¹æ®Šå­—å…ƒçš„è¼¸å…¥</li>
</ul></li>
</ul></li>
</ul></li>
<li>Integration Tests
<ul>
<li>å°‡è¨±å¤šå€‹ Unit çµ„åˆä¹‹å¾Œä¸€èµ·é€²è¡Œæ¸¬è©¦ï¼Œç¢ºä¿é€™äº›éƒ¨ä»¶ç„¡è«–æ˜¯ï¼š
<ul>
<li>åœ¨ä¸€èµ·éš¨æ©Ÿé‹ä½œ</li>
<li>æœ‰ç‰¹å®šç›®çš„é‹ä½œ</li>
<li>æˆ–ç”šè‡³æ¨¡æ“¬ç‰¹å®šæƒ…æ³çš„é‹ä½œï¼Œéƒ½æ˜¯æ­£ç¢ºç„¡èª¤çš„ã€‚</li>
</ul></li>
<li>é™¤äº†éš¨æ©Ÿäº¤äº’ä½œç”¨ä¹‹å¤–ï¼Œæ¨¡æ“¬çš„æƒ…æ³å¯èƒ½æœ‰ï¼šOwner Operationã€WhiteList
Operationã€User Operation ç­‰ã€‚</li>
</ul></li>
<li>Regression Tests
<ul>
<li>ä»¥è¿´æ­¸çš„æ–¹å¼ä¾†å°ç‰ˆæœ¬é‡æ¸¬ï¼Œç¢ºå®šèˆŠç‰ˆæœ¬ Bug
æ–¼ä¿®æ­£å¾Œä¸æœƒåœ¨æ–°ç‰ˆæœ¬ä¸­å‡ºç¾ã€‚</li>
<li>æœƒå˜—è©¦å»æ¨¡æ“¬ç¾å¯¦ä¸–ç•Œçš„é‹è¡Œæµï¼Œé€šå¸¸æœƒæœ‰å¤šå€‹ä½¿ç”¨è€…éš¨æ©Ÿæ“ä½œç”¢å“ï¼Œä¹Ÿæœƒæœ‰ä¸åŒåœ°æ–¹çš„
Providerï¼Œé€™æ¨£å¯ä»¥å»æ¸¬è©¦ç³»çµ±ä¸­æ˜¯å¦æœ‰ Deadlock
çš„ç™¼ç”Ÿï¼Œæˆ–è€…ä¸æ­£å¸¸ç”šè‡³ä¸æ–·é‡è¤‡å‘¼å«æŸä¸€å€‹åŠŸèƒ½çš„æƒ…æ³ã€‚</li>
<li>ç¯„ä¾‹åœ–ç‰‡<a
href="https://quantstamp.com/blog/securing-your-defi-project-starts-with-quality-testing">å‡ºè™•</a></li>
</ul></li>
</ul>
<p><img src="https://i.imgur.com/PSm0W4G.jpg" /> * Special Tests *
é‡å°ç‰¹å®šæ”»æ“Šæˆ–è€…ç›®çš„é€²è¡Œé é˜²æ¸¬è©¦ï¼Œä¾‹å¦‚é‡é€æ”»æ“Šã€é–ƒé›»è²¸ç­‰ã€‚</p>
<h3 id="what-features-can-we-use-in-foundry">What features can we use in
Foundry</h3>
<p>Foundry ç”±ä»¥ä¸‹å…©è€…çµ„æˆï¼š - <a
href="https://github.com/gakonst/foundry/tree/master/forge"><strong>Forge</strong></a>ï¼š
å’Œæˆ‘å€‘å¹³å¸¸ä½¿ç”¨çš„å…¶ä»–é–‹ç™¼å·¥å…·ä¸€æ¨£ï¼Œæ˜¯ä¸€å€‹ Ethereum çš„æ¸¬è©¦æ¡†æ¶ã€‚ - <a
href="https://github.com/gakonst/foundry/tree/master/cast"><strong>Cast</strong></a>ï¼šæ”¯æ´å¤šç¨®å®¢æˆ¶ç«¯åŠŸèƒ½ï¼Œåƒæ˜¯èˆ‡
EVM
æ™ºèƒ½åˆç´„äº’å‹•ã€å‚³éäº¤æ˜“ã€å–å¾—éˆä¸Šè³‡è¨Šç­‰ï¼Œå°±å¦‚åŒä¸€æŠŠç‘å£«åˆ€ï¼ˆå®˜æ–¹æ–‡ä»¶å¯«çš„ï¼‰ã€‚</p>
<p>ä¾†è‡ªå®˜æ–¹çš„ Foundry ç‰¹æ€§ï¼š * å¿«é€Ÿä¸”å½ˆæ€§çš„ç·¨è­¯ Pipeline *
è‡ªå‹•åµæ¸¬ä¸¦ä¸‹è¼‰ Solidity ä¸åŒç‰ˆæœ¬çš„ç·¨è­¯å™¨ï¼ˆunder ~/.svmï¼‰ *
å¢é‡ç·¨è­¯å’Œç·©å­˜: åªæœ‰è¢«ä¿®æ”¹çš„æª”æ¡ˆæœƒè¢«é‡æ–°ç·¨è­¯ * ä¸¦è¡Œç·¨è­¯ *
æ”¯æ´éç‰¹å®šçš„ç›®éŒ„çµæ§‹ï¼ˆe.g.Â Hardhat reposï¼‰ * ä»¥ Solidity æ’°å¯«æ¸¬è©¦ *
å¿«é€Ÿçš„ Fuzz testingï¼Œèƒ½å¤ æ”¶æ–‚åˆ°æœ€å°çš„è¼¸å…¥ï¼Œä¸¦è¼¸å‡ºå…¶åä¾‹ * å¿«é€Ÿçš„é ç«¯ RPC
åˆ†å²”æ¨¡å¼, åˆ©ç”¨é¡ä¼¼ tokio çš„ Rust ç•°æ­¥é‹è¡Œæ¶æ§‹ * å½ˆæ€§çš„ debug
ç´€éŒ„è¼¸å‡ºï¼ˆloggingï¼‰ * Dapptools-style: DsTestâ€™s emitted logs *
Hardhat-style: console.sol contract * éå¸¸è¼•é‡ï¼ˆ5-10MBï¼‰ï¼Œä¸éœ€è¦ Nix
ä¹‹é¡çš„å¥—ä»¶ç®¡ç†å™¨ * èƒ½èˆ‡ Foundry GitHub å¿«é€Ÿçš„ CIï¼ˆæŒçºŒæ€§æ•´åˆï¼‰</p>
<h3 id="preparation">Preparation</h3>
<p>å¦‚æœä½œæ¥­ç³»çµ±æ˜¯ Linux æˆ– macOS æœ€ç°¡å–®çš„æ–¹æ³•å°±æ˜¯ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•ä¸‹è¼‰
Foundryï¼š</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>curl <span class="op">-</span>L https<span class="op">:</span><span class="co">//foundry.paradigm.xyz | bash</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>foundryup</span></code></pre></div>
<p>ä¸‹è¼‰å®Œæˆä¹‹å¾Œå†åŸ·è¡Œä¸€æ¬¡ <code>foundryup</code> æœƒå°‡ Foundry
æ›´æ–°è‡³æœ€æ–°ç‰ˆæœ¬ï¼Œå¦‚æœæƒ³è¦è¿”å›åˆ°æŒ‡å®šç‰ˆæœ¬ï¼Œå‰‡ä½¿ç”¨æŒ‡ä»¤
<code>foundryup -v $VERSION</code>ã€‚</p>
<p>ç„¶è€Œæˆ‘è‡ªå·±æ˜¯ä½¿ç”¨ Windowsï¼Œä¸‹è¼‰çš„æ–¹å¼å¦‚ä¸‹ã€‚</p>
<p>åœ¨ä¸‹è¼‰ Foundry ä¹‹å‰å¾—å…ˆæ“æœ‰ Rust å’Œ Cargoï¼Œé¦–å…ˆåˆ° rustup.rs ä¸‹è¼‰
rustï¼Œç„¶å¾ŒåŸ·è¡Œï¼š</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>rustup<span class="op">-</span>init</span></code></pre></div>
<p>é€™æ¨£å°±èƒ½åŒæ™‚æº–å‚™å¥½ Rust å’Œ Cargoï¼Œæœ€å¾Œæ‰“é–‹ CMD ä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤å®‰è£
Foundryã€‚</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>cargo install <span class="op">--</span>git https<span class="op">:</span><span class="co">//github.com/foundry-rs/foundry foundry-cli anvil --bins --locked</span></span></code></pre></div>
<p>ä¸‹è¼‰æˆåŠŸä»¥å¾Œåœ¨é›»è…¦çš„æŸå€‹åœ°æ–¹ä½¿ç”¨ <code>init</code>
åˆå§‹åŒ–ä¸€å€‹å°ˆæ¡ˆã€‚</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>$ forge init defi<span class="op">-</span>testing</span></code></pre></div>
<p>forge CLI å°‡æœƒå‰µå»ºå…©å€‹æª”æ¡ˆç›®éŒ„ï¼š<code>lib</code> å’Œ
<code>src</code>ã€‚</p>
<ul>
<li><strong><code>lib</code></strong> åŒ…å«äº† testing contract
(lib/ds-test/src/test.sol)ï¼ŒåŒæ™‚ä¹Ÿæœ‰å…¶ä»–å„å¼å„æ¨£æ¸¬è©¦åˆç´„çš„å¯¦ä½œ
demo(lib/ds-test/demo/demo.sol)</li>
<li><strong><code>src</code></strong>
æ”¾äº†æˆ‘å€‘å¯«çš„æ™ºèƒ½åˆç´„å’Œæ¸¬è©¦çš„åŸå§‹ç¢¼</li>
</ul>
<div class="sourceCode" id="cb5"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="op">.</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>â”œâ”€â”€ foundry<span class="op">.</span><span class="at">toml</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>â”œâ”€â”€ lib</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>â”‚   â”œâ”€ds<span class="op">-</span>test</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>â”‚   â”‚  â”œâ”€demo</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>â”‚   â”‚  â””â”€src</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>â”‚   â””â”€â”€ forge<span class="op">-</span>std</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>â”‚       â”œâ”€â”€ lib</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>â”‚       â”œâ”€â”€ LICENSE<span class="op">-</span>APACHE</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>â”‚       â”œâ”€â”€ LICENSE<span class="op">-</span>MIT</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>â”‚       â”œâ”€â”€ README<span class="op">.</span><span class="at">md</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>â”‚       â””â”€â”€ src</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>â””â”€â”€ src</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    â”œâ”€â”€ Contract<span class="op">.</span><span class="at">sol</span> </span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    â””â”€â”€ test</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>        â””â”€â”€Contract<span class="op">.</span><span class="at">t</span><span class="op">.</span><span class="at">sol</span></span></code></pre></div>
<p>ä¹‹å¾Œä¸€æ¨£åœ¨çµ‚ç«¯æ©Ÿçš„éƒ¨åˆ†ï¼Œè¼¸å…¥æŒ‡ä»¤ï¼š</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>$ forge install OpenZeppelin<span class="op">/</span>openzeppelin<span class="op">-</span>contracts</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>Installing openzeppelin<span class="op">-</span>contracts <span class="kw">in</span> <span class="st">&quot;C:</span><span class="sc">\\</span><span class="st">Users</span><span class="sc">\\</span><span class="st">qazws</span><span class="sc">\\</span><span class="st">Desktop</span><span class="sc">\\</span><span class="st">Blockchain</span><span class="sc">\\</span><span class="st">defi-testing</span><span class="sc">\\</span><span class="st">lib</span><span class="sc">\\</span><span class="st">openzeppelin-contracts&quot;</span><span class="op">,</span> (url<span class="op">:</span> https<span class="op">:</span><span class="co">//github.com/OpenZeppelin/openzeppelin-contracts, tag: None)</span></span></code></pre></div>
<p>ä¾¿å¯ä»¥åœ¨ <code>lib</code> ä¸­çœ‹è¦‹ OpenZeppelin çš„åˆç´„å€‘ã€‚</p>
<p>åœ¨ <code>foundry.toml</code> è£¡é¢æ±ºå®š Foundry çš„é‹è¡Œè¨­å®šï¼ŒåŒ…å« Remap
æˆ‘å€‘ import æˆ–åŸ·è¡Œå‘½ä»¤çš„è·¯å¾‘ï¼Œä»¥ä¸‹åˆ—å‡ºä¸€äº›å¸¸ç”¨çš„åƒæ•¸ï¼š</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>[<span class="im">default</span>]</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>src <span class="op">=</span> <span class="st">&#39;src&#39;</span>                                                   # the source directory</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>test <span class="op">=</span> <span class="st">&#39;test&#39;</span>                                                 # the test directory</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>out <span class="op">=</span> <span class="st">&#39;out&#39;</span>                                                   # the output <span class="fu">directory</span> (<span class="cf">for</span> artifacts)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>libs <span class="op">=</span> [<span class="st">&#39;lib&#39;</span>]                                                # a list <span class="kw">of</span> library directories</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>remappings <span class="op">=</span> [<span class="st">&#39;ds-test/=lib/ds-test/src/&#39;</span><span class="op">,</span> </span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>              <span class="st">&quot;@openzeppelin/=lib/openzeppelin-contracts/&quot;</span>]   # a list <span class="kw">of</span> remappings</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>evm_version <span class="op">=</span> <span class="st">&#39;london&#39;</span>                                        # the evm <span class="fu">version</span> (by hardfork name)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>#solc_version <span class="op">=</span> <span class="st">&#39;0.8.10&#39;</span>                                      # override <span class="cf">for</span> the solc <span class="fu">version</span> (setting <span class="kw">this</span> <span class="fu">ignores</span> <span class="vs">`auto_detect_solc`</span>)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>sender <span class="op">=</span> <span class="st">&#39;0xB42faBF7BCAE8bc5E368716B568a6f8Fdf3F84ec&#39;</span>         # the address <span class="kw">of</span> <span class="vs">`msg.sender`</span> <span class="kw">in</span> tests</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>tx_origin <span class="op">=</span> <span class="st">&#39;0x00a329c0648769a73afac7f9381e08fb43dbea72&#39;</span>      # the address <span class="kw">of</span> <span class="vs">`tx.origin`</span> <span class="kw">in</span> tests</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>initial_balance <span class="op">=</span> <span class="st">&#39;0xffffffffffffffffffffffff&#39;</span>                # the initial balance <span class="kw">of</span> the test contract</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>gas_limit <span class="op">=</span> <span class="dv">9223372036854775807</span>                               # the gas limit <span class="kw">in</span> tests</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>gas_price <span class="op">=</span> <span class="dv">0</span>                                                 # the gas <span class="fu">price</span> (<span class="kw">in</span> wei) <span class="kw">in</span> tests</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>block_timestamp <span class="op">=</span> <span class="dv">0</span>                                           # the value <span class="kw">of</span> <span class="vs">`block.timestamp`</span> <span class="kw">in</span> tests</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>gas_reports <span class="op">=</span> [<span class="st">&quot;*&quot;</span>]    </span></code></pre></div>
<p>æ›´å¤šè©³ç´°å…§å®¹å¯æŸ¥çœ‹ä»¥ä¸‹<a
href="https://github.com/gakonst/foundry/tree/master/config">é€£çµ</a>ã€‚</p>
<hr />
<h2 id="brewing-time---basic-defi-project">â€œBrewingâ€ Time - Basic Defi
Project</h2>
<h3 id="implementation---simple-staking-contract">Implementation -
Simple Staking Contract</h3>
<p>ä¸‰å€‹å¹³è¡Œåˆç´„è¼”ä»¥ <code>ERC20</code>ã€<code>Ownable</code> å’Œ
<code>safeMath</code> ç­‰å‡½å¼åº«çš„é™½æ˜¥ DeFi Stakingã€‚åŸºæœ¬ä¸Šå°±æ˜¯ User
å¯ä»¥é€éæŠµæŠ¼ stableCoinï¼Œæ›å–æŠµæŠ¼æ™‚é–“è¨ˆç®—è€Œå¾—çš„ holdToken æ”¶ç›Šã€‚</p>
<h4 id="contract.sol">Contract.sol</h4>
<pre class="solidity="><code>// SPDX-License-Identifier: MIT
pragma solidity &gt;=0.8.0;

import &quot;./StableCoin.sol&quot;;
import &quot;./LP.sol&quot;;
import &quot;./safeMath.sol&quot;;
import &quot;./Ownable.sol&quot;;

contract Farm is Ownable {
    LP public holdToken;
    StableCoin public dai;

    constructor(LP _holdToken, StableCoin _dai) {
        holdToken = _holdToken;
        dai = _dai;
    }

    /** ---------------- Constructs the Data Structures ---------------- */

    struct ClientInfo {
        uint startTime;
        uint stakingBalance;
        uint yieldBalance;
        bool isStaking;
    }

    mapping(address =&gt; ClientInfo) public ClientList;

    /** ---------------- Getter Function ---------------- */

    function getClientStartTime(address _addr) view public returns(uint){
        return ClientList[_addr].startTime;
    
    // pass...

    /** ---------------- Algorithms ---------------- */

    function stakeTokens(uint _amount) public {
       // pass...
    }

    function calYield(address _address) public view returns(uint){
       // pass...
    }

    function withdrawYield() public {
       // pass...
    }

    function unstakeTokens() public {
       // pass...
}</code></pre>
<h4 id="stablecoin.sol">StableCoin.sol</h4>
<pre class="solidity="><code>pragma solidity &gt;=0.8.0;

import &quot;@openzeppelin/contracts/token/ERC20/ERC20.sol&quot;;

contract StableCoin is ERC20 {

    uint256 public initialSupply = 10000;
    constructor() ERC20(&quot;TestDAI&quot;, &quot;tDAI&quot;) {
        _mint(msg.sender, initialSupply);
    }
}</code></pre>
<h4 id="lp.sol">LP.sol</h4>
<pre class="solidity="><code>pragma solidity &gt;=0.8.0;

import &quot;@openzeppelin/contracts/token/ERC20/ERC20.sol&quot;;

contract LP is ERC20 {

    uint256 public initialSupply = 10000;
    constructor() ERC20(&quot;MyToken&quot;, &quot;MT&quot;) {
        _mint(msg.sender, initialSupply);
    }
}</code></pre>
<h3 id="dev-tools.">Dev Tools.</h3>
<p>å¦‚æœéœ€è¦ç’°å¢ƒè®Šæ•¸å¯ä»¥å¢è¨­ <code>.env</code>ï¼š</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>PRIVATE_KEY<span class="op">=&lt;</span>your_private_key<span class="op">&gt;</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>RPC_URL<span class="op">=&lt;</span>your_API_key<span class="op">&gt;</span></span></code></pre></div>
<h4 id="gas-report">Gas Report</h4>
<div class="sourceCode" id="cb12"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>$ forge test <span class="op">--</span>gas<span class="op">-</span>report</span></code></pre></div>
<h4 id="use-hardhat-to-deploy">Use Hardhat to Deploy</h4>
<p>ä¸‹è¼‰ Hardhat ä½œç‚ºé–‹ç™¼å·¥å…·ï¼Œé¸æ“‡
<code>Create an empty hardhat.config.js</code>ï¼š</p>
<pre class="javascript="><code>$ yarn add hardhat
$ yarn hardhat
&gt;
888    888                      888 888               888
888    888                      888 888               888
888    888                      888 888               888
8888888888  8888b.  888d888 .d88888 88888b.   8888b.  888888
888    888     &quot;88b 888P&quot;  d88&quot; 888 888 &quot;88b     &quot;88b 888
888    888 .d888888 888    888  888 888  888 .d888888 888
888    888 888  888 888    Y88b 888 888  888 888  888 Y88b.
888    888 &quot;Y888888 888     &quot;Y88888 888  888 &quot;Y888888  &quot;Y888

Welcome to Hardhat v2.9.6

? What do you want to do? ... 
  Create a basic sample project
  Create an advanced sample project
  Create an advanced sample project that uses TypeScript
&gt; Create an empty hardhat.config.js
  Quit</code></pre>
<p>ä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤åœ¨æœ¬åœ°åŸ·è¡Œæ¨¡æ“¬çš„ JSON RPC ç’°å¢ƒï¼Œå¾—åˆ°ä¸€äº›å¯ä¾›æ¸¬è©¦çš„
Accountsï¼š</p>
<pre class="javascript="><code>$ yarn hardhat node
&gt;
Started HTTP and WebSocket JSON-RPC server at http://127.0.0.1:8545/

Accounts
========

WARNING: These accounts, and their private keys, are publicly known.
Any funds sent to them on Mainnet or any other live network WILL BE LOST.

Account #0: 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266 (10000 ETH)
Private Key: 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80

Account #1: 0x70997970C51812dc3A010C7d01b50e0d17dc79C8 (10000 ETH)
Private Key: 0x59c6995e998f97a5a0044966f0945389dc9e86dae88c7a8412f4603b6b78690d

...

Account #19: 0x8626f6940E2eb28930eFb4CeF49B2d1F2C9C1199 (10000 ETH)
Private Key: 0xdf57089febbacf7ba0bc227dafbffa9fc08a93fdc68e1e42411a14efcf23656e

WARNING: These accounts, and their private keys, are publicly known.
Any funds sent to them on Mainnet or any other live network WILL BE LOST.</code></pre>
<p>é–‹å•Ÿä¸€å€‹æ–°çš„ Terminal ä¾†æ¸¬è©¦ Deployï¼š</p>
<div class="sourceCode" id="cb15"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>$ forge create <span class="op">&lt;</span>ContractName<span class="op">&gt;</span> <span class="op">--</span><span class="kw">private</span><span class="op">-</span>key <span class="op">&lt;</span>your_private_key<span class="op">&gt;</span> <span class="op">--</span>rpc<span class="op">-</span>url <span class="op">&lt;</span>RPC_URL<span class="op">&gt;</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>$ forge create Contract <span class="op">--</span><span class="kw">private</span><span class="op">-</span>key <span class="op">&lt;</span>dyour_private_key<span class="op">&gt;</span> <span class="op">--</span>rpc<span class="op">-</span>url http<span class="op">:</span><span class="co">//127.0.0.1:8545/</span></span></code></pre></div>
<p>ä¹Ÿå¯ä»¥æ‰“é–‹ Ganache ä½¿ç”¨ http://127.0.0.1:7545/ ä¾†é…åˆã€‚</p>
<hr />
<h2 id="tasting-time">â€œTastingâ€ Time</h2>
<h3 id="more-features-can-use">More features can use</h3>
<p>Foundry åŒæ¨£ä¹Ÿæ”¯æŒ <a
href="https://en.wikipedia.org/wiki/Fuzzing">Fuzzing</a>
æ¸¬è©¦ã€‚å› ç‚ºç•¶æˆ‘å€‘ä¸€å€‹ä¸€å€‹å‡½å¼éƒ½é€²è¡Œæ¸¬è©¦æ™‚ï¼Œå³ä¾¿å…¨éƒ¨éƒ½æˆåŠŸ
PASSï¼Œä½†åœ¨é‚Šéš›æ¸¬è³‡ä¸­å…¶å¯¦ä¹Ÿå¾ˆæœ‰å¯èƒ½æœƒå‡ºç¾ä¸€äº›å•é¡Œï¼Œå°è‡´ Under/Overflow
æˆ–å…¶ä»– RuntimeError/Memory Leak ä¹‹é¡çš„éŒ¯èª¤ã€‚</p>
<p>æˆ‘å€‘åœ¨æ¸¬è©¦å‡½å¼ä¸­å¢åŠ åƒæ•¸ä¹‹å¾Œï¼ŒFuzzing èƒ½å¤ è®“ Solidity test runner
éš¨æ©Ÿé¸æ“‡å¤§é‡çš„åƒæ•¸è¼¸å…¥æˆ‘å€‘çš„å‡½å¼ã€‚</p>
<pre class="solidity="><code>function testDoubleWithFuzzing(uint256 x) public {
    foo.set(x);
    require(foo.x() == x);
    foo.double();
    require(foo.x() == 2 * x);
}</code></pre>
<p>åœ¨ä»¥ä¸Šä¾‹å­ä¸­ fuzzer æœƒè‡ªå‹•åœ°å° <code>x</code>
å˜—è©¦å„ç¨®éš¨æ©Ÿæ•¸ï¼Œå¦‚æœä»–ç™¼ç¾ç•¶å‰è¼¸å…¥æœƒå°è‡´æ¸¬è©¦å¤±æ•—ï¼Œä¾¿æœƒå›å‚³éŒ¯èª¤ï¼Œé€™æ™‚å€™å°±å¯ä»¥é–‹å§‹
debug å•¦ï¼</p>
<p>é€²è¡Œæ¸¬è©¦ï¼š</p>
<div class="sourceCode" id="cb17"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>$ forge test</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>[<span class="dv">2</span><span class="er">K</span>[<span class="dv">1</span><span class="er">m</span>[[<span class="dv">32</span><span class="er">mâ †</span>[<span class="dv">0</span><span class="op">;</span><span class="dv">1</span><span class="er">m</span>][<span class="dv">0</span><span class="er">m</span> Compiling<span class="op">...</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>[<span class="dv">2</span><span class="er">K</span>[<span class="dv">1</span><span class="er">m</span>[[<span class="dv">32</span><span class="er">mâ ”</span>[<span class="dv">0</span><span class="op">;</span><span class="dv">1</span><span class="er">m</span>][<span class="dv">0</span><span class="er">m</span> Compiling <span class="dv">1</span> files <span class="cf">with</span> <span class="fl">0.8.10</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>Compiler run successful</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>Running <span class="dv">3</span> tests <span class="cf">for</span> FooTest<span class="op">.</span><span class="at">json</span><span class="op">:</span>FooTest</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>[<span class="dv">32</span><span class="er">m</span>[PASS][<span class="dv">0</span><span class="er">m</span> <span class="fu">testDouble</span>() (gas<span class="op">:</span> <span class="dv">9384</span>)</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>[<span class="dv">31</span><span class="er">m</span>[FAIL<span class="op">.</span> <span class="at">Reason</span><span class="op">:</span> Arithmetic over<span class="op">/</span>underflow<span class="op">.</span> <span class="at">Counterexample</span><span class="op">:</span> calldata<span class="op">=</span><span class="bn">0xc80b36b68000000000000000000000000000000000000000000000000000000000000000</span><span class="op">,</span> args<span class="op">=</span>[<span class="dv">57896044618658097711785492504343953926634992332820282019728792003956564819968</span>]][<span class="dv">0</span><span class="er">m</span> <span class="fu">testDoubleWithFuzzing</span>(uint256) (runs<span class="op">:</span> <span class="dv">4</span><span class="op">,</span> Î¼<span class="op">:</span> <span class="dv">2867</span><span class="op">,</span> <span class="op">~:</span> <span class="dv">3823</span>)</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>[<span class="dv">32</span><span class="er">m</span>[PASS][<span class="dv">0</span><span class="er">m</span> <span class="fu">testFailDouble</span>() (gas<span class="op">:</span> <span class="dv">9290</span>)</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>Failed tests<span class="op">:</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>[<span class="dv">31</span><span class="er">m</span>[FAIL<span class="op">.</span> <span class="at">Reason</span><span class="op">:</span> Arithmetic over<span class="op">/</span>underflow<span class="op">.</span> <span class="at">Counterexample</span><span class="op">:</span> calldata<span class="op">=</span><span class="bn">0xc80b36b68000000000000000000000000000000000000000000000000000000000000000</span><span class="op">,</span> args<span class="op">=</span>[<span class="dv">57896044618658097711785492504343953926634992332820282019728792003956564819968</span>]][<span class="dv">0</span><span class="er">m</span> <span class="fu">testDoubleWithFuzzing</span>(uint256) (runs<span class="op">:</span> <span class="dv">4</span><span class="op">,</span> Î¼<span class="op">:</span> <span class="dv">2867</span><span class="op">,</span> <span class="op">~:</span> <span class="dv">3823</span>)</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>Encountered a total <span class="kw">of</span> [<span class="dv">31</span><span class="er">m1</span>[<span class="dv">0</span><span class="er">m</span> failing tests<span class="op">,</span> [<span class="dv">32</span><span class="er">m2</span>[<span class="dv">0</span><span class="er">m</span> tests succeeded</span></code></pre></div>
<p>å¾ä»¥ä¸ŠéŒ¯èª¤æœƒç™¼ç¾ç•¶åƒæ•¸è¼¸å…¥ç‚º
<code>57896044618658097711785492504343953926634992332820282019728792003956564819968</code>
ä¹‹å¾Œæœƒå‡ºç¾éŒ¯èª¤ï¼Œä¾†åˆ° <a
href="https://www.wolframalpha.com/">wolframe</a> è²¼ä¸Šé€™å€‹æ•¸å­—æœƒç™¼ç¾å…¶ç‚º
<code>5.789 * 10^76 ~= 2^255</code>ã€‚</p>
<p>è½èµ·ä¾†ååˆ†åˆç†å› ç‚º <code>x</code> çš„å‹æ…‹æ˜¯
<code>uint256</code>ï¼Œæ‰€ä»¥å¦‚æœè¦é¿å…ç¨‹å¼å‡ºç¾å•é¡Œï¼Œå‹¢å¿…è¦åœ¨è©²æ¸¬è©¦å‡½å¼è£¡é¢å¢åŠ ä¸€äº›<strong>é—œæ–¼å‹æ…‹å®šç¾©çš„æ¢ä»¶</strong>ï¼Œå¾…æœƒæˆ‘æœƒè§£é‡‹ï¼</p>
<p>æœªä¾† Foundry é™¤äº† Fuzz Testing ä¹‹å¤–ï¼Œé‚„æœƒæ”¯æ´ï¼š * Invariant Testing *
Symbolic Execution * Mutation Testing</p>
<div class="info">
<p>New Features å¯ä»¥åœ¨é€™å…©å€‹ Repo æ‰¾åˆ°ï¼š * <a
href="https://github.com/gakonst/foundry/blob/master/forge/README.md">forge
package</a> * <a
href="https://github.com/gakonst/foundry/blob/master/cli/README.md">CLI
README</a>.</p>
</div>
<h3 id="cheating">Cheating</h3>
<div class="sourceCode" id="cb18"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>$ forge install foundry<span class="op">-</span>rs<span class="op">/</span>forge<span class="op">-</span>std</span></code></pre></div>
<p>ä¸‹è¼‰äº† Standard Library ä¹‹å¾Œåœ¨ <code>Contract.t.sol</code>
æˆ‘å€‘å°±æ”¹ç¹¼æ‰¿ <code>Test.sol</code> ä¸ç”¨ <code>ds-test</code> çš„
<code>test.sol</code>ã€‚å› ç‚º <code>Test.sol</code> å·²ç¶“å¯¦ä½œäº†
<code>ds-test</code>ã€<code>Vm.sol</code> å’Œ <code>console.sol</code>
é€™äº›æˆ‘å€‘éœ€è¦çš„éƒ¨åˆ†ï¼š</p>
<pre class="solidity="><code>// SPDX-License-Identifier: Unlicense
pragma solidity &gt;=0.6.0 &lt;0.9.0;

import &quot;./Vm.sol&quot;;
import &quot;ds-test/test.sol&quot;;
import &quot;./console.sol&quot;;
import &quot;./console2.sol&quot;;

// Wrappers around Cheatcodes to avoid footguns
abstract contract Test is DSTest {
    using stdStorage for StdStorage;

    uint256 private constant UINT256_MAX = 115792089237316195423570985008687907853269984665640564039457584007913129639935;

    event WARNING_Deprecated(string msg);

    Vm public constant vm = Vm(HEVM_ADDRESS);
    StdStorage internal stdstore;

    /*//////////////////////////////////////////////////////////////////////////
                                    STD-CHEATS
    //////////////////////////////////////////////////////////////////////////*/
    
    // ...
}</code></pre>
<p>ç‰¹åˆ¥æ˜¯ï¼š</p>
<pre class="solidity"><code>Vm public constant vm = Vm(HEVM_ADDRESS);</code></pre>
<p>å‰ä¸€å€‹ç‰ˆæœ¬çš„ Foundry æ˜¯åˆ©ç”¨å®£å‘Š <code>CheatCodes</code>
çš„ä»‹é¢ï¼Œå¾Œåœ¨æ¸¬è©¦åˆç´„è£¡é¢å®£å‘Š
<code>cheats</code>ã€‚æœ€å¾Œåªè¦åœ¨æˆ‘å€‘æƒ³è¦æ¸¬è©¦çš„åˆç´„è£¡é¢åŠ ä¸Š
<code>cheats.prank(address(0));</code> å°±å¯ä»¥æŠŠè‡ªå·±çš„è§’åº¦è½‰æˆ
<code>address(0)</code>ã€‚</p>
<pre class="solidity="><code>interface CheatCodes {
  function prank(address) external;
}

contract ContractTest is DSTest {
  CheatCodes cheats = CheatCodes(HEVM_ADDRESS);
    
  // skip the code...
    
  function testFailNotWLMint() public {
    cheats.prank(address(0));
    carman.preSaleMint(10);
  }  
}</code></pre>
<h3 id="initialization-first-testing">Initialization &amp; First
Testing</h3>
<p><code>vm</code> æ˜¯ Foundry ä¸­çš„ CheatingCodeï¼Œå¯ç”¨æ–¼æ¨¡æ“¬ã€Œè©² Test
Function ä¸­ã€çš„ EVM å’Œå€å¡Šéˆç‹€æ³ï¼Œä¾‹å¦‚ <code>vm.assume</code>
å¯ç”¨æ–¼æŒ‡å®šè®Šæ•¸æ€§è³ªã€<code>vm.warp</code> å¯ä»¥æŒ‡å®š
<code>block.timestamp</code> ç­‰ã€‚</p>
<pre class="solidity="><code>// SPDX-License-Identifier: MIT
pragma solidity &gt;= 0.8.10;

import &quot;forge-std/Test.sol&quot;;
import &quot;../Contract.sol&quot;;
import &quot;../StableCoin.sol&quot;;
import &quot;../LP.sol&quot;;

contract FarmTest is Test {

    Farm public farm;
    LP public holdToken;
    StableCoin public dai;

    address DEPLOYER_ADDRESS;

    function setUp() public {
        holdToken = new LP();
        dai = new StableCoin();
        farm = new Farm(holdToken, dai);
        DEPLOYER_ADDRESS = farm.owner(); // (DEPLOYER == address(this)) != (msg.sender == &lt;sender_in_foundry.toml&gt;)
    }
    
    function testOwner() public {
        assertEq(DEPLOYER_ADDRESS, farm.owner());
    }

    function testMockContractInit() public {
        // Initial Mint
        assertEq(holdToken.balanceOf(DEPLOYER_ADDRESS), holdToken.initialSupply());
        assertEq(dai.balanceOf(DEPLOYER_ADDRESS), holdToken.initialSupply());
    }

    function testMockContractTransferFrom(uint256 _amount) public {
        vm.assume(_amount &lt;= holdToken.initialSupply() &amp;&amp; _amount &lt;= dai.initialSupply());

        holdToken.approve(DEPLOYER_ADDRESS, _amount);
        holdToken.transferFrom(DEPLOYER_ADDRESS, address(1), _amount);
        assertEq(holdToken.balanceOf(address(1)), _amount);

        dai.approve(DEPLOYER_ADDRESS, _amount);
        dai.transferFrom(DEPLOYER_ADDRESS, address(1), _amount);
        assertEq(dai.balanceOf(address(1)), _amount);
    }
}</code></pre>
<p>é€™é‚Šä¸»è¦æ¸¬è©¦ Owner å’Œå…©å€‹ ERC-20 åˆç´„çš„é‹ä½œæ˜¯å¦æ­£å¸¸ã€‚</p>
<pre class="javascript="><code>$ forge test
&gt;
[â †] Compiling...
[â ƒ] Compiling 4 files with 0.8.10
[â Š] Solc 0.8.10 finished in 2.79s
Compiler run successful (with warnings)

[PASS] testMockContractInit() (gas: 21400)
[PASS] testMockContractTransferFrom(uint256) (runs: 256, Î¼: 95003, ~: 107435)
[PASS] testOwner() (gas: 9852)

Test result: ok. 3 passed; 0 failed; finished in 0.64s</code></pre>
<p>éœ€è¦æ³¨æ„çš„é»æœ‰ï¼š 1. ä»¥ new å®£å‘Šåˆç´„ä¹‹å¾Œå¯å–å¾—å…¶åœ°å€ä½œç‚º Constructor
çš„åƒæ•¸å‚³å…¥ 2. <code>&lt;contract_deployer&gt; == address(this)</code> 3.
<code>msg.sender == &lt;sender_in_foundry.toml&gt;</code> 4.
<code>&lt;contract_deployer&gt; != msg.sender</code> 5. é—œæ–¼ Approve å’Œ
Transfer çš„ç”¨æ³•èˆ‡ä½¿ç”¨æ™‚æ©Ÿåƒè€ƒï¼š * <a
href="https://eips.ethereum.org/EIPS/eip-20">EIP-20: Token Standard</a>
* <a
href="https://ethereum.org/zh-tw/developers/tutorials/transfers-and-approval-of-erc-20-tokens-from-a-solidity-smart-contract/">TRANSFERS
AND APPROVAL OF ERC-20 TOKENS FROM A SOLIDITY SMART CONTRACT</a></p>
<h3 id="msg.sender-in-foundry">msg.sender in Foundry</h3>
<p><code>msg.sender</code> åœ¨ Foundry ä¸€ç›´æ˜¯æˆ‘è¦ºå¾—éå¸¸é ­ç—›çš„å•é¡Œã€‚</p>
<p>å¤§å®¶é‚„è¨˜å¾—ä¹‹å‰çš„ <code>foundry.toml</code> å—ï¼å¦‚æœæˆ‘å€‘åœ¨è£¡é¢åŠ ä¸Šåƒæ•¸
<code>sender</code> å°±å¯ä»¥æŒ‡å®šåœ¨åˆç´„æ¸¬è©¦æ™‚é è¨­çš„
<code>msg.sender</code>ï¼š</p>
<div class="sourceCode" id="cb24"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>[<span class="im">default</span>]</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>src <span class="op">=</span> <span class="st">&#39;src&#39;</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>out <span class="op">=</span> <span class="st">&#39;out&#39;</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>libs <span class="op">=</span> [<span class="st">&#39;lib&#39;</span>]</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>remappings <span class="op">=</span> [<span class="st">&#39;forge-std/=lib/forge-std/src/&#39;</span><span class="op">,</span><span class="st">&#39;ds-test/=lib/ds-test/src/&#39;</span><span class="op">,</span> <span class="st">&quot;@openzeppelin/=lib/openzeppelin-contracts/&quot;</span>]</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>sender <span class="op">=</span> <span class="st">&#39;0xB42faBF7BCAE8bc5E368716B568a6f8Fdf3F84ec&#39;</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>block_timestamp <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a># See more config options https<span class="op">:</span><span class="co">//github.com/gakonst/foundry/tree/master/config</span></span></code></pre></div>
<p>å¾å®˜æ–¹æ–‡ä»¶æ•´ç†çš„å‡½å¼æ¯”è¼ƒè¡¨ï¼š | <a
href="https://book.getfoundry.sh/cheatcodes/prank.html">OriginalCheatcode</a>
|Statement | <a
href="https://book.getfoundry.sh/reference/forge-std/std-cheats.html">related
Forge-STD</a> | | â€”â€”â€“ | â€”â€”â€“ | â€”â€”â€“ | | <code>prank(address)</code> | Sets
<code>msg.sender</code> to the specified address for the next call. â€œThe
next callâ€ includes static calls as well, but not calls to the cheat
code address. |<code>hoax</code> | | <code>startPrank(address)</code> |
Sets <code>msg.sender</code> for all subsequent calls until
<code>stopPrank</code> is called. | <code>startHoax</code>,
<code>changePrank</code> | | <code>stopPrank(address)</code> | Stops an
active prank started by <code>startPrank</code>, resetting
<code>msg.sender</code> and <code>tx.origin</code> to the values before
<code>startPrank</code> was called. | |</p>
<p>åœ¨ Foundry-STD ä¸­ä¹Ÿå¯ä»¥ä½¿ç”¨ <code>console.log</code>
çš„æ¨¡æ“¬ç’°å¢ƒï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ <code>prank()</code> åªé©ç”¨æ–¼<strong>ä¸‹ä¸€å€‹
external call</strong>ï¼Œè€Œ, <code>console.log</code> ä¸¦ä¸æ˜¯ external
call æ‰€ä»¥æ²’è¾¦æ³•å°å‡ºæˆ‘å€‘æƒ³åƒä¸­çš„åœ°å€ã€‚</p>
<p>èˆ‰ä¾‹ä¾†èªªæˆ‘å€‘æƒ³è¦å‡è£æœ‰ä¸€å€‹ EOA ä¾† Deploy åˆç´„ï¼š</p>
<pre class="solidity="><code>Vm public constant vm = Vm(HEVM_ADDRESS);

function setUp() public {
    vm.startPrank(address(deployer));
    deployedContract = new MyContract();
    vm.stopPrank();
}</code></pre>
<p>å…ˆä¾†çœ‹ç¬¬ä¸€å€‹ Prank æ¸¬è©¦ï¼š</p>
<pre class="solidity="><code>/** Unit Testing For Mock Contracts*/

    function testPrank1() public {
        assertEq(DEPLOYER_ADDRESS, farm.owner()); // now owner() is DEPLOYER
        farm.transferOwnership(msg.sender); 
        // the transaction originator of transferOwnership is the &quot;contract&quot; ---&gt; DEPLOYER == address(this)  
        assertEq(msg.sender, farm.owner()); // transfer successfully
        // now owner is the &quot;msg.sender&quot; ---&gt; &lt;sender_in_foundry.toml&gt;

        vm.prank(DEPLOYER_ADDRESS);  // change the &quot;msg.sender&quot; ---&gt; DEPLOYER == address(this)
        try farm.transferOwnership(msg.sender){
            assertTrue(false, &quot;prank failed!&quot;);
            // transferOwnership should revert, 
            // when &quot;msg.sender&quot; is now being the DEPLOYER, but the owner is &lt;sender_in_foundry.toml&gt;

            // if transferOwnership not revert,
            // it means the function called successfully,
            // ---&gt; the &quot;msg.sender&quot; is still the &lt;sender_in_foundry.toml&gt;
            // ---&gt; we prank failed.
        } catch {
            assertTrue(true);
            // revert successfully
        }

        // The most important thing is that the prank is only useful for &quot;external&quot; call
        // the only &quot;external&quot; call above is &quot;farm.transferOwnership()&quot;
    }</code></pre>
<p>å†ä¾†çœ‹çœ‹å¦å¤–ä¸€å€‹æ¸¬è©¦ï¼š</p>
<p><code>msg.sender</code> åœ¨æ¸¬è©¦æª”æ¡ˆä¸­æ˜¯ä¸€å€‹æœƒå‘¼å«æ¯å€‹ test function çš„
EOAã€‚è€Œ <code>prank()</code> æ˜¯ä¸€å€‹ test function
ä¸­çš„å‡½å¼ï¼Œç›®çš„æ˜¯å»ã€Œæ”¹è®Š external call çš„
callerã€ï¼Œä¸¦ä¸æœƒå‘å¤–å½±éŸ¿åˆ°æ•´å€‹æ¸¬è©¦æª”çš„
<code>msg.sender</code>ï¼Œå› æ­¤æ²’è¾¦æ³•å½±éŸ¿åˆ°ä¸æ˜¯ external call
çš„å°è±¡ï¼Œä¾‹å¦‚ï¼š<code>assertEq</code>ã€‚</p>
<pre class="solidity="><code>    function testPrank2() public {
        assertEq(msg.sender, 0xB42faBF7BCAE8bc5E368716B568a6f8Fdf3F84ec); //[PASS]
        assertEq(DEPLOYER_ADDRESS, address(this)); // [PASS]
        assertEq(DEPLOYER_ADDRESS, farm.owner()); // [PASS]
        /**
        vm.prank(DEPLOYER_ADDRESS);
        assertEq(DEPLOYER_ADDRESS, msg.sender); // [Failed] 
            ---&gt; Because &quot;assertEq()&quot; is not external call
         */
    }</code></pre>
<p>é™¤äº† <code>msg.sender</code>
ä¹‹å¤–ï¼Œå¦å¤–ä¸€å€‹æ›´é ­ç—›çš„å•é¡Œæ˜¯å„ç¨®è£œå……å¯¦ä½œçš„
selectorï¼Œæœªä¾†æœ‰æ©Ÿæœƒå†è·Ÿå¤§å®¶åˆ†äº«ã€‚ :::info
å…¶ä¸­ä¸€å€‹æˆ‘æå‡ºä¾†ä¸¦è§£æ±ºçš„å•é¡Œå¾Œä¾†è¢«åŠ åˆ°å®˜æ–¹æ–‡ä»¶çš„ <a
href="https://book.getfoundry.sh/tutorials/solmate-nft.html#extending-our-nft-contract-functionality-and-testing">NFT
æ¸¬è©¦ç¯„ä¾‹</a>è£¡é¢äº†ï¼ 1. <a
href="https://github.com/foundry-rs/foundry/discussions/964">Error From
Testing ERC-721 Contract Mint Function #964</a> 2. <a
href="https://ethereum.stackexchange.com/questions/125238/catching-custom-error">Catching
custom error</a> :::</p>
<h3 id="unit-testing">Unit Testing</h3>
<p>è¶…ç´šé™½æ˜¥çš„æŠŠå››å€‹å‡½å¼æ¸¬è©¦ä¸€æ¬¡ï¼ŒåŸºæœ¬ä¸Šé€™è£¡æ²’æœ‰å¯¦ä½œå¤ªèŠ±ä¿çš„å…§å®¹ï¼Œæ¯”è¼ƒéœ€è¦æ³¨æ„çš„é»æœ‰å¹¾å€‹ï¼š
1. é—œæ–¼å…©ç¨®ä»£å¹£çš„æ¨¡å‹ï¼Œåœ¨è¨­è¨ˆä¸ŠåŒ…å«ä¾›çµ¦é‡å¾—ç‰¹åˆ¥æ³¨æ„ï¼Œä½†ç”±æ–¼æ˜¯ Mock
ä¾†ç¤ºç¯„åœ°æ‰€ä»¥æ²’æœ‰ç‰¹åˆ¥è‘—å¢¨ã€‚ 2. åš Input Fuzzing Test çš„æ™‚å€™å¯ä»¥è€ƒæ…® +1
æˆ–è€… -1 ä¾†çœ‹æ˜¯å¦æœƒå°è‡´éŒ¯èª¤ã€‚ 3. å¯ä»¥ä½¿ç”¨å¤šå€‹ mockAddress
ä¾†åšäº¤äº’æ¸¬è©¦ï¼Œä¸ä¸€å®šè¦ç”¨ test Contract æœ¬èº«ç•¶ receiver æˆ–
senderï¼Œé€™å€‹éƒ¨åˆ†æˆ‘ä¸‹ä¸€æ¬¡å†ä»‹ç´¹ã€‚ 4. æ¨¡æ“¬ä½¿ç”¨è€…æƒ…å¢ƒçš„æ™‚å€™è©²åœ¨ Dapp
å¯¦ä½œçš„éƒ¨åˆ†è¦è£œä¸Šï¼Œä¾‹å¦‚ <code>approve()</code>ã€‚</p>
<h4 id="teststaking">testStaking</h4>
<p>åˆç´„åŸå§‹ç¢¼ï¼š</p>
<pre class="solidity="><code>    function stakeTokens(uint _amount) public {
        require(_amount &gt; 0, &#39;You cannot stake 0 tokens&#39;);

        uint oldDaiBal = dai.balanceOf(msg.sender);
        require( oldDaiBal &gt; _amount, &quot;insufficient DAI!&quot;);

        uint256 allowance = dai.allowance(msg.sender, address(this));
        require(allowance &gt;= _amount, &quot;Check the token allowance&quot;);
        
        dai.transferFrom(msg.sender, address(this), _amount);
        require(dai.balanceOf(msg.sender) == oldDaiBal - _amount, &quot;Transfer Failed!&quot;);
        require(dai.balanceOf(address(this)) == _amount, &quot;Transfer Failed!&quot;);

        uint oldBalance = ClientList[msg.sender].stakingBalance;
        ClientList[msg.sender].stakingBalance = SafeMath.add(ClientList[msg.sender].stakingBalance, _amount);
        require(ClientList[msg.sender].stakingBalance &gt; oldBalance, &quot;Staking Bug!&quot;);

        ClientList[msg.sender].startTime = block.timestamp;
        ClientList[msg.sender].isStaking = true;
    }</code></pre>
<p>ç›¸å°æ‡‰çš„æ¸¬è©¦ï¼š</p>
<pre class="solidity="><code>    function testStaking(uint256 _amount) public {
        vm.assume(_amount &gt; 0 &amp;&amp; _amount &lt;= holdToken.initialSupply() &amp;&amp; _amount &lt;= dai.initialSupply());
        assertEq(dai.balanceOf(DEPLOYER_ADDRESS), dai.initialSupply());

        vm.startPrank(DEPLOYER_ADDRESS);
        dai.approve(address(farm), _amount);
        farm.stakeTokens(_amount);
        assertEq(dai.balanceOf(DEPLOYER_ADDRESS), dai.initialSupply() - _amount);
        assertEq(farm.getClientStakingBalance(DEPLOYER_ADDRESS), _amount);
        assertEq(farm.getClientStartTime(DEPLOYER_ADDRESS), block.timestamp);
        assertEq(farm.getClientYieldBalance(DEPLOYER_ADDRESS), 0);
        assertEq(farm.getClientIsStaking(DEPLOYER_ADDRESS), true);
        vm.stopPrank();
    }</code></pre>
<h4 id="testcalyield">testCalYield</h4>
<p>åˆç´„åŸå§‹ç¢¼ï¼š</p>
<pre class="solidity="><code>    function calYield(address _address) public view returns(uint){
        uint end = block.timestamp;
        uint totalTime = SafeMath.sub(end, ClientList[_address].startTime);
        return SafeMath.div(totalTime, 60);
        // Yield Per Minute
    }</code></pre>
<p>ç›¸å°æ‡‰çš„æ¸¬è©¦ï¼š</p>
<pre class="solidity="><code>    function testCalYield(uint _amount, uint32 _timeRoll) public {
        vm.assume(_amount &gt; 0 &amp;&amp; _amount &lt;= holdToken.initialSupply() &amp;&amp; _amount &lt;= dai.initialSupply());
        vm.assume(_timeRoll &lt; 2**32);
        assertEq(dai.balanceOf(DEPLOYER_ADDRESS), dai.initialSupply());

        vm.startPrank(DEPLOYER_ADDRESS);
        // Stake
        dai.approve(address(farm), _amount);
        farm.stakeTokens(_amount);
        assertEq(dai.balanceOf(DEPLOYER_ADDRESS), dai.initialSupply() - _amount);
        assertEq(farm.getClientStakingBalance(DEPLOYER_ADDRESS), _amount);
        assertEq(farm.getClientStartTime(DEPLOYER_ADDRESS), block.timestamp);
        assertEq(farm.getClientYieldBalance(DEPLOYER_ADDRESS), 0);
        assertEq(farm.getClientIsStaking(DEPLOYER_ADDRESS), true);

        // CalYield
        vm.warp(_timeRoll);
        uint result = SafeMath.div(SafeMath.sub(_timeRoll, farm.getClientStartTime(DEPLOYER_ADDRESS)), 60);
        assertEq(farm.calYield(DEPLOYER_ADDRESS), result);

        vm.stopPrank();
    }</code></pre>
<h4 id="testwithdrawyield">testWithdrawYield</h4>
<p>åˆç´„åŸå§‹ç¢¼ï¼š</p>
<pre class="solidity="><code>    function withdrawYield() public {

        uint profit = calYield(msg.sender);
        uint withdraw = SafeMath.div(SafeMath.mul(ClientList[msg.sender].stakingBalance, profit), 100);

        if(ClientList[msg.sender].yieldBalance &gt; 0){
            uint originalYBal = ClientList[msg.sender].yieldBalance;
            ClientList[msg.sender].yieldBalance = 0;
            withdraw = SafeMath.add(withdraw, originalYBal);
        }

        if(withdraw == 0 &amp;&amp; ClientList[msg.sender].yieldBalance == 0){
            return ;
        }

        ClientList[msg.sender].startTime = block.timestamp;
        holdToken.transfer(msg.sender, withdraw);
    }</code></pre>
<p>ç›¸å°æ‡‰çš„æ¸¬è©¦ï¼š</p>
<pre class="solidity="><code>    function testWithdrawYield(uint256 _amount, uint _timeRoll) public {
        vm.assume(_amount &gt; 0 &amp;&amp; _amount &lt;= holdToken.initialSupply() &amp;&amp; _amount &lt;= dai.initialSupply());
        assertEq(dai.balanceOf(DEPLOYER_ADDRESS), dai.initialSupply());

        vm.startPrank(DEPLOYER_ADDRESS);
        // Stake
        dai.approve(address(farm), _amount);
        farm.stakeTokens(_amount);
        assertEq(dai.balanceOf(DEPLOYER_ADDRESS), dai.initialSupply() - _amount);
        assertEq(farm.getClientStakingBalance(DEPLOYER_ADDRESS), _amount);
        assertEq(farm.getClientStartTime(DEPLOYER_ADDRESS), block.timestamp);
        assertEq(farm.getClientYieldBalance(DEPLOYER_ADDRESS), 0);
        assertEq(farm.getClientIsStaking(DEPLOYER_ADDRESS), true);

        // withdrawYield
        vm.assume(_timeRoll &lt; 2**8); 
        // here is a risk of that holdtoken.totalSupply &lt; withdraw, 
        // this defi should hava a better Tokenomics Model
        vm.warp(_timeRoll);
        farm.withdrawYield();
        uint withdraw = SafeMath.add(
                            SafeMath.div(
                                SafeMath.mul(farm.getClientStakingBalance(DEPLOYER_ADDRESS), 
                                    SafeMath.div(
                                        SafeMath.sub(_timeRoll, farm.getClientStartTime(DEPLOYER_ADDRESS))
                                    , 60))
                            , 100)
                        , farm.getClientYieldBalance(DEPLOYER_ADDRESS));
        
        if(withdraw &gt; 0 || farm.getClientYieldBalance(DEPLOYER_ADDRESS) &gt; 0){
            assertEq(holdToken.balanceOf(DEPLOYER_ADDRESS), withdraw);
            assertEq(farm.getClientYieldBalance(DEPLOYER_ADDRESS), 0);
            assertEq(farm.getClientStartTime(DEPLOYER_ADDRESS), _timeRoll);
        }
        vm.stopPrank();

        // Stake Status Check Again
        assertEq(dai.balanceOf(DEPLOYER_ADDRESS), dai.initialSupply() - _amount);
        assertEq(farm.getClientStakingBalance(DEPLOYER_ADDRESS), _amount);
        assertEq(farm.getClientIsStaking(DEPLOYER_ADDRESS), true);
    }</code></pre>
<h4 id="testunstaking">testUnStaking</h4>
<p>åˆç´„åŸå§‹ç¢¼ï¼š</p>
<pre class="solidity="><code>    function unstakeTokens() public {
        require(ClientList[msg.sender].isStaking, &#39;You are not staker!&#39;);
        
        withdrawYield();
        
        uint balance = ClientList[msg.sender].stakingBalance;
        require(balance &gt; 0, &quot;There is no fund in your staking account!&quot;);
        
        // need to prevent re-entrancy attack later!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        dai.transfer(msg.sender, balance);
        ClientList[msg.sender].stakingBalance = 0;
        ClientList[msg.sender].isStaking = false;
    }</code></pre>
<p>ç›¸å°æ‡‰çš„æ¸¬è©¦ï¼š</p>
<pre class="solidity="><code>    function testUnStaking(uint256 _amount) public {
        vm.assume(_amount &gt; 0 &amp;&amp; _amount &lt;= holdToken.initialSupply() &amp;&amp; _amount &lt;= dai.initialSupply());
        assertEq(dai.balanceOf(DEPLOYER_ADDRESS), dai.initialSupply());

        vm.startPrank(DEPLOYER_ADDRESS);
        // Stake
        dai.approve(address(farm), _amount);
        farm.stakeTokens(_amount);
        assertEq(dai.balanceOf(DEPLOYER_ADDRESS), dai.initialSupply() - _amount);
        assertEq(farm.getClientStakingBalance(DEPLOYER_ADDRESS), _amount);
        assertEq(farm.getClientStartTime(DEPLOYER_ADDRESS), block.timestamp);
        assertEq(farm.getClientYieldBalance(DEPLOYER_ADDRESS), 0);
        assertEq(farm.getClientIsStaking(DEPLOYER_ADDRESS), true);

        // Unstake
        farm.unstakeTokens();
        assertEq(dai.balanceOf(DEPLOYER_ADDRESS), dai.initialSupply());
        assertEq(farm.getClientStakingBalance(DEPLOYER_ADDRESS), 0);
        assertEq(farm.getClientStartTime(DEPLOYER_ADDRESS), block.timestamp);
        assertEq(farm.getClientYieldBalance(DEPLOYER_ADDRESS), 0);
        assertEq(farm.getClientIsStaking(DEPLOYER_ADDRESS), false);
        vm.stopPrank();
    }</code></pre>
<hr />
<h2 id="tipsy">Tipsy</h2>
<h3 id="conclusion">Conclusion</h3>
<p>å¯«æ¸¬è©¦çš„æ„Ÿè¦ºè·Ÿä¹‹å‰åœ¨ç•¶ç¨‹å¼è¨­è¨ˆåŠ©æ•™çš„æ¨£å­å¾ˆåƒï¼Œé›–ç„¶ä¸Šæ–‡æ²’æœ‰ç‰¹åˆ¥è¨­è¨ˆä¸€äº›æƒ…æ³ä¾†æª¢æ¸¬ï¼Œä½†éå¾€çµç›¡è…¦æ±æƒ³æ¸¬è³‡ä¾†è€ƒå­¸ç”Ÿé€™ä»¶äº‹å±…ç„¶é‚„å¹«ä¸Šå¿™ğŸ˜‚</p>
<p>å› ç‚ºæœ€è¿‘è¦æœŸæœ«è€ƒï¼ˆå¯æ†å¤§å­¸ç”Ÿï¼‰ï¼Œæ‰€ä»¥ Integration Testã€Regression
Testã€Special Test æˆ‘ç•™åˆ°ä¸‹ä¸€ç¯‡å†ä¾†åˆ†äº«ï¼</p>
<p>é€™ç¯‡æ–‡ç« éå¸¸æ„Ÿè¬æ™ºç¨‹è€å¸«ã€é™³å“è€å¸«ã€ç‹¸è²“è€å¸«çµ¦äºˆååˆ†æœ‰å¹«åŠ©çš„å»ºè­°ï¼</p>
<h3 id="reference-citation">Reference &amp; Citation</h3>
<ul>
<li><a
href="https://ethereum.org/en/developers/docs/smart-contracts/testing/">TESTING
SMART CONTRACTS</a></li>
<li><a
href="http://eprints.cs.univie.ac.at/7141/1/document.pdf">Maximilian
Wohrer and Uwe Zdun, â€œDevOps for Ethereum Blockchain Smart
Contracts,â€</a></li>
</ul>
<h4 id="defi-testing">DeFi Testing</h4>
<ul>
<li><a
href="https://quantstamp.com/blog/securing-your-defi-project-starts-with-quality-testing">Securing
Your DeFi Project Starts with Quality Testing</a></li>
<li><a
href="https://www.apriorit.com/business-case-studies-list/747-evaluating-smart-contract-security-for-defi">Evaluating
Smart Contract Security for Decentralized Finance (DeFi)</a></li>
<li><a
href="https://blog.chain.link/testing-chainlink-smart-contracts/">Testing
Chainlink Smart Contracts</a></li>
<li><a
href="https://defisolutions.com/general-news/2017/05/16/defi-engineering-cult-quality/">defi
ENGINEERING: A CULT OF QUALITY</a></li>
<li><a
href="https://blaize.tech/article-type/how-to-build-a-successful-defi-project/#Project-Testing">HOW
TO BUILD A SUCCESSFUL DEFI PROJECT?</a></li>
<li><a
href="https://blaize.tech/article-type/defi-security-how-to-prevent-your-defi-project-from-hacking/">DEFI
SECURITY AUDIT: HOW TO PREVENT YOUR DEFI PROJECT FROM HACKING?</a></li>
</ul>
<h4 id="defi-protocol">DeFi Protocol</h4>
<ul>
<li><a
href="https://github.com/tradingstrategy-ai/web3-ethereum-defi/tree/master/tests">Python___tradingstrategy-ai/web3-ethereum-defi</a></li>
<li><a
href="https://github.com/yieldprotocol/yield-liquidator-v2/blob/master/test/test_flashLiquidator.ts">Hardhat___yieldprotocol/yield-liquidator-v2</a></li>
<li><a
href="https://github.com/sense-finance/space-v1/tree/main/src/tests">Foundry___sense-finance/space-v1</a></li>
<li><a
href="https://github.com/pendle-finance/pendle-core/tree/master/test">Hardhat___pendle-finance/pendle-core</a></li>
<li><a
href="https://github.com/tranche-jibrel/tranche-compound-protocol/tree/master/test">Truffle___tranche-jibrel/tranche-compound-protocol</a></li>
<li><a
href="https://github.com/notional-finance/contracts/tree/master/test">Ethers___notional-finance/contracts</a></li>
<li><a
href="https://github.com/element-fi/elf-contracts/tree/main/test">Hardhat___element-fi/elf-contracts</a></li>
<li><a
href="https://github.com/BarnBridge/BarnBridge-YieldFarming/tree/master/test">Hardhat___BarnBridge/BarnBridge-YieldFarming</a></li>
<li><a
href="https://github.com/BarnBridge/BarnBridge-SmartYieldBonds/tree/master/test">Hardhat___BarnBridge/BarnBridge-SmartYieldBonds</a></li>
<li><a
href="https://github.com/XY-Finance/xy-protocol/blob/master/tests/test_client_swap.py">Python___XY-Finance/xy-protocol</a></li>
<li><a
href="https://github.com/hakkafinance/blackholeswap/blob/master/contracts/blackholeswapV1.sol">hakkafinance/blackholeswap</a></li>
</ul>
<h4 id="foundry-official-doc.github">Foundry Official Doc./Github</h4>
<ul>
<li><a href="https://book.getfoundry.sh/index.html">Foundry
Book</a></li>
<li><a
href="https://github.com/foundry-rs/foundry">foundry-rs/foundry</a></li>
<li><a
href="https://github.com/foundry-rs/forge-std">foundry-rs/forge-std</a></li>
</ul>
<h4 id="foundry-resources">Foundry Resources</h4>
<ul>
<li><a href="https://www.youtube.com/watch?v=Rp_V7bYiTCM">How to Foundry
with Brock Elmore</a></li>
<li><a
href="https://github.com/crisgarner/awesome-foundry?fbclid=IwAR2ypJ1Pj1EpTmoFmT5OuqTGDHR-ce0yFsdFMyVdiY3Hg08MSNJV8whN0Ss">crisgarner/awesome-foundry</a></li>
<li><a href="https://www.youtube.com/watch?v=fNMfMxGxeag">Intro to
Foundry | The FASTEST Smart Contract Framework</a></li>
<li><a
href="https://jamesbachini.com/foundry-tutorial/#foundry-cheat-codes">Foundry
Tutorial | How To Debug &amp; Deploy Solidity Smart Contracts</a></li>
<li><a
href="https://book.tictactoken.co/chapters/1/setting-up-foundry.html">Tic-Tac-Token-Foundry</a></li>
<li><a
href="https://github.com/nicolasgarcia214/damn-vulnerable-defi-foundry">Damn
Vulnerable DeFi - Foundry Version âš’ï¸</a></li>
</ul>
<h3 id="dev.-roadmap">Dev. Roadmap</h3>
<ul>
<li>Development
<ul>
<li>Gas optimization</li>
<li>Contract upgradability</li>
<li>Contract complexity</li>
</ul></li>
<li>Sercurity
<ul>
<li>100% Testing Coverage</li>
<li>Auditing</li>
<li>Code Uniqueness</li>
</ul></li>
</ul>
<h4 id="testing-spec">Testing Spec</h4>
<ul>
<li>Variable Analysis</li>
<li>Object List</li>
<li>Contract Inheritance Graph</li>
<li>Potential Risk</li>
<li>User and Provider Type</li>
</ul>
<h4 id="testing-enviornment">Testing Enviornment</h4>
<ul>
<li>Local testing</li>
<li>Testing on testnet</li>
<li>Transaction debug</li>
</ul>
<hr />
<h2 id="foundry-de-problem-list">Foundry De-Problem List</h2>
<h3 id="download-foundry-problem">1. Download Foundry Problem</h3>
<p>å¦‚æœåœ¨ä¸‹è¼‰éç¨‹ä¸­åƒæˆ‘ä¸€æ¨£é‡åˆ°ä»¥ä¸‹éŒ¯èª¤ï¼š</p>
<div class="sourceCode" id="cb36"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>error<span class="op">:</span> linker link<span class="op">.</span><span class="at">exe</span> not found</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">=</span> note<span class="op">:</span> program not found</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>note<span class="op">:</span> the msvc targets depend on the msvc linker but link<span class="op">.</span><span class="at">exe</span> was not found</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>note<span class="op">:</span> please ensure that VS <span class="dv">2013</span><span class="op">,</span> VS <span class="dv">2015</span><span class="op">,</span> VS <span class="dv">2017</span> or VS <span class="dv">2019</span> was installed <span class="cf">with</span> the Visual C<span class="op">++</span> option</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>error<span class="op">:</span> could not compile proc<span class="op">-</span>macro2 due to previous error</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>warning<span class="op">:</span> build failed<span class="op">,</span> waiting <span class="cf">for</span> other jobs to finish<span class="op">...</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>error<span class="op">:</span> failed to <span class="fu">compile</span> <span class="vs">`foundry-cli v0.1.0 (https://github.com/gakonst/foundry#d66f9d58)`</span><span class="op">,</span> intermediate artifacts can be found at C<span class="op">:</span>\Users\qazws\AppData\Local\Temp\cargo<span class="op">-</span>installe6Rd6Y</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>Caused by<span class="op">:</span></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>  build failed</span></code></pre></div>
<p>åªè¦ä¸‹è¼‰ <a href="https://www.blogger.com/null">Visual Studio 2019
Build tools</a>ï¼Œé¸æ“‡ C++ Build Tools
ç„¶å¾Œé‡é–‹æ©Ÿå°±å¯ä»¥è§£æ±ºäº†ï¼ä¸‹è¼‰å¤§å°ç´„æ˜¯ 6 GBã€‚</p>
<h3 id="functional-inheritance-problem">2. Functional Inheritance
Problem</h3>
<p>åœ¨ä½¿ç”¨æŸäº›ç¹¼æ‰¿ä¾†çš„å‡½å¼æ™‚ï¼Œè¦ç¢ºä¿è¢«ç¹¼æ‰¿è£¡é¢çš„åƒæ•¸æˆ–è®Šæ•¸å—é«”ç‚ºä½•ï¼Œç°¡å–®ä¾†èªªå°±æ˜¯ç”¨åˆç´„å»æ¸¬è©¦åˆç´„ï¼ˆFoundryï¼‰çš„æ™‚å€™ï¼Œå’Œç”¨å‰ç«¯å»æ¸¬è©¦åˆç´„ï¼ˆJavascriptï¼‰çš„è§’åº¦é‚„æ˜¯æœƒæœ‰ä¸åŒã€‚</p>
<p>ä¾‹å¦‚ï¼šå¦‚æœæ²’æœ‰å¯¦ä½œ <code>_checkOnERC721Received</code>
çš„è©±ï¼Œåœ¨åˆç´„è£¡é¢ç›´æ¥å®£å‘Š <code>_safeMint()</code>
ä»¥å¾Œæœƒå‡ºç¾ä»¥ä¸‹éŒ¯èª¤ï¼š</p>
<pre><code>Running 1 test for CarManTest.json:CarManTest
ï¿½[31m[FAIL. Reason: ERC721: transfer to non ERC721Receiver implementer]ï¿½[0m testDeployerCanMint() (gas: 192214)

Failed tests:
ï¿½[31m[FAIL. Reason: ERC721: transfer to non ERC721Receiver implementer]ï¿½[0m testDeployerCanMint() (gas: 192214)

Encountered a total of ï¿½[31m1ï¿½[0m failing tests, ï¿½[32m0ï¿½[0m tests succeeded</code></pre>
<p><code>_checkOnERC721Received</code> æœ‰ä¸€å€‹ verification logic
å­˜åœ¨ï¼Œå¦‚æœä»Šå¤© <code>to</code> çš„åœ°å€æ˜¯ä¸€å€‹åˆç´„è€Œä¸æ˜¯
EOAï¼Œé‚£å°±éœ€è¦å¯¦ä½œå®ƒçš„ bodyï¼Œé€™æ¨£æ‰å¯ä»¥åœ¨ ERC-721 çš„ä»‹é¢è£¡é¢å›å‚³æ­£ç¢ºçš„ 4
bytes hashã€‚</p>
<pre class="solidity="><code>  function onERC721Received(
      address, 
      address, 
      uint256, 
      bytes calldata
  )external pure returns(bytes4) {
      return bytes4(keccak256(&quot;onERC721Received(address,address,uint256,bytes)&quot;));
  } </code></pre>
<h3 id="bash-make-command-not-found">3. bash: make: command not
found</h3>
<p>åˆ°æ­¤<a href="https://chocolatey.org/install#individual">é€£çµ</a>ä¸‹è¼‰
chocoï¼Œå®Œæˆä¹‹å¾Œè¼¸å…¥ä»¥ä¸‹æŒ‡ä»¤ï¼š</p>
<pre><code>$ choco install make</code></pre>
<h3 id="cargo-install-problem-vm-forge-stdtest.sol-is-not-working">4.
cargo install Problem || (vm || forge-std/Test.sol is not working)</h3>
<ol type="1">
<li>æ›´æ–° Foundryï¼Œå»å®˜æ–¹æ–‡ä»¶ç”¨æœ€æ–°çš„æ–¹æ³•å†ä¸‹è¼‰ä¸€æ¬¡</li>
<li>æŸ¥çœ‹ <a
href="https://book.getfoundry.sh/reference/index.html">cheatcode
&amp;&amp; forge-std Reference</a></li>
<li>æŸ¥çœ‹ vm å’Œ test åŸå§‹ç¢¼</li>
<li>æŸ¥çœ‹ forge-std åŸå§‹ç¢¼</li>
</ol>
<hr />
<div class="info">
<p>æœ€å¾Œæ­¡è¿å¤§å®¶æ‹æ‰“é¤µé£Ÿçª®è‹¦å¤§å­¸ç”Ÿ<a
href="https://etherscan.io/address/0x2b83c71A59b926137D3E1f37EF20394d0495d72d"><code>0x2b83c71A59b926137D3E1f37EF20394d0495d72d</code></a>
ğŸ˜¥</p>
</div>
